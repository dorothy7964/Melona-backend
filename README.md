# ì˜¬ ë•Œ ë©”ë¡œë‚˜

ì†Œì•¡ ëŒ€í–‰ ì„œë¹„ìŠ¤ í”„ë¡œì íŠ¸ ì…ë‹ˆë‹¤. <br/><br/>
[frontend Github ë°”ë¡œê°€ê¸°](https://github.com/dorothy7964/melona_frontend "frontend Github ë°”ë¡œê°€ê¸°") <br/>
[app Github ë°”ë¡œê°€ê¸°](https://github.com/dorothy7964/melona-app "app Github ë°”ë¡œê°€ê¸°")

<br/><br/>

### ì£¼ìš” ê¸°ëŠ¥

1. ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”
2. ë¡œê·¸ì¸ ì‹œ í† í° ì¸ì¦ ë° í•´ì„
3. ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì´ë©”ì¼ë¡œ ë°›ê¸°
4. AWS S3ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ì§„ ì €ì¥

<br/><br/>

### Backend Stack

- NodeJS
- Prisma
- GraphQL

<br/><br/>

# Install

## nodemon

<!-- Install Code -->

```js
$ yarn add nodemon -D
```

nodemon ì€ íŒŒì¼ì„ ì €ì¥í•  ë•Œë§ˆë‹¤ ì‹¤í–‰ì„ ìƒˆë¡œ í•´ì£¼ëŠ” ë„êµ¬ ì…ë‹ˆë‹¤. <br/>
ì„œë²„ë¥¼ ê»ë‹¤ê°€ ì¼¤ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. <br/>

<br/><br/>

## @babel-cli

<!-- Install Code -->

```js
$ yarn add @babel-cli
```

babelì€ es6ì½”ë“œë¥¼ es5ë¡œ ë°”ê¿”ì£¼ëŠ” ë„êµ¬ ì…ë‹ˆë‹¤. <br/>
ì•„ì§ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê³³ë“¤ì´ ìˆì–´ì„œ ëª»ìƒê¸´ ì½”ë“œë¡œ ë°”ê¿”ì¤˜ì•¼ í•©ë‹ˆë‹¤. <br/>

<br/><br/>

## @babel/node

<!-- Install Code -->

```js
$ yarn add @babel/node
```

ìš”ì•½ : ì½˜ì†”ì—ì„œ JS íŒŒì¼ì„ ì‹¤í–‰ <br />
babel-nodeëŠ” Node.js CLIì™€ ì •í™•íˆ ë™ì¼í•˜ê²Œ ì‘ë™í•˜ëŠ” CLIë¡œ, <br />
ì‹¤í–‰í•˜ê¸° ì „ì— Babel ì‚¬ì „ ì„¤ì • ë° í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ì»´íŒŒì¼í•  ìˆ˜ ìˆëŠ” ë¶€ê°€ì ì¸ ì´ì ì´ ìˆìŠµë‹ˆë‹¤. <br />

<br/><br/>

## @babel/preset-env

<!-- Install Code -->

```js
$ yarn add @babel/preset-env
```

ìš”ì•½ : ì½”ë“œ ì—…ë°ì´íŠ¸ <br />
ECMAScript5+ ë²„ì „ í˜¸í™˜ì„±ì„ ìœ„í•˜ì—¬ ì •ì˜ëœ í”ŒëŸ¬ê·¸ì¸ì˜ ì§‘í•© ì…ë‹ˆë‹¤. <br/>
ì‘ì„±í•œ ì½”ë“œê°€ ê´œì°®ì€ì§€ ë³€í™˜ë˜ì–´ì•¼ í•˜ëŠ”ì§€ íŒë‹¨ í•´ì¤ë‹ˆë‹¤. <br />
ë¬¸ë²•ì— ëŒ€í•´ ì„¸ë¶€ ì‘ì—…ì„ í•  í•„ìš” ì—†ì´ ìµœì‹  ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²•ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•´ì¤ë‹ˆë‹¤. <br />

<br/><br/>

## @babel/core

<!-- Install Code -->

```js
$ yarn add @babel/core
```

Babelì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í”ŒëŸ¬ê·¸ì¸ (babel.config.js) ì…ë‹ˆë‹¤.

<br/><br/>

## morgan

<!-- Install Code -->

```js
$ yarn add morgan
```

morgan ì´ë¼ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì¶”ê°€í•˜ê³  logger(ë¡œê¹… ì „ë¬¸ ëª¨ë“ˆ) ì…ë‹ˆë‹¤.

<br/><br/>

## dotenv

<!-- Install Code -->

```js
$ yarn add dotenv
```

prisma ë¥¼ ì‹œì‘í•˜ì§€ ì „ dotenv ì„¤ì¹˜ í•©ë‹ˆë‹¤. <br/>
ì„œë²„ë¥¼ ë¨¼ì € ì„¸ìš°ê³ , ê·¸ ë‹¤ìŒì— prisma ë¥¼ ì„œë²„ ì½”ë“œì— ì¶”ê°€ í•©ë‹ˆë‹¤.

<br/><br/>

## graphql-yoga

<!-- Install Code -->

```js
$ yarn add graphql-yoga
```

ìš”ì•½ : create-react-appì˜ graqlQL ë²„ì „ <br/>
ì˜ì¡´ì„± ëª¨ë“ˆ(dependency)ë“¤ì„ ì„¤ì¹˜ í•©ë‹ˆë‹¤. <br/>
graphql-yogaë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— expressëŠ” í•„ìš” ì—†ìŠµë‹ˆë‹¤. <br/>
í˜„ì¬ apollo ì—…ë°ì´íŠ¸ë¡œ ì„œë²„ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê³  ì…‹ì—…ë„ ì‰¬ì›Œì¡Œë‹¤.

<br/><br/>

## graphql-tools

<!-- Install Code -->

```js
$ yarn add graphql-tools
```

graphql íŒŒì¼ ë¶„ë¦¬ í•˜ë ¤ë©´ í•„ìš” í•©ë‹ˆë‹¤.

<br/><br/>

## prisma-client-lib

<!-- Install Code -->

```js
$ yarn add prisma-client-lib
```

Terminal ì—ì„œ prisma ì½˜ì†”ì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br/>
prisma ì™€ ì •ë³´ë¥¼ ì£¼ê³  ë°›ìŠµë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ í•´ë³´ê¸° (prisma-client-lib)

<!-- Example Code -->

```js
import { prisma } from "../../../../generated/prisma-client";

export default {
  Query: {
    sayHello: async () => {
      console.log(await prisma.users()); // console.log
      return "Hello";
    }
  }
};
```

<br/>

**ì‹¤í–‰**

```js
$ yarn dev
```

<br/><br/>

## merge-graphql-schemas

<!-- Install Code -->

```js
$ yarn add merge-graphql-schemas
```

graphql íŒŒì¼ ë¶„ë¦¬ í•˜ë ¤ë©´ í•„ìš” í•©ë‹ˆë‹¤.

<br/><br/>

<!--ã…‡ã…‡ã…‡ã…‡ã…‡ã…‡ã…‡ã…‡ -->

## ë§Œì•½ babel/cli -D ë¡œ ì„¤ì¹˜ í–ˆì„ ê²½ìš° ì œê±°í•´ì£¼ê¸°

<!-- Install Code -->

```js
$ yarn remove babel-cli
$ yarn global remove babel-cli
```

[ì˜¤ë¥˜ë°œìƒ] babel/cli -D ë¡œ ì„¤ì¹˜ í–ˆì„ ê²½ìš° ìµœì‹  ë²„ì „ @babel/clli ë¥¼ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

<br/><br/>

# íŒŒì¼ ìƒì„±

### nodemon.json íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
{
    "ext": "js graphql"
}
```

ì´ íŒŒì¼ì— ext ë¼ëŠ” ê±¸ ì¶”ê°€ í•©ë‹ˆë‹¤. <br/>
nodemonì´ ê°ì‹œí•´ì•¼ í•  íŒŒì¼ì˜ í™•ì¥ìë“¤ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/><br/>

### .gitignore íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
{
// ~/wam-prj/prismagram/.gitignore

# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# TypeScript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env

# next.js build output
.next
generated
build
}
```

ì—…ë¡œë“œ ì œì™¸í•  ê²ƒë“¤ ë„£ì–´ìŠµë‹ˆë‹¤.

<br/><br/>

### .env íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
PORT = 4000;
```

### .babelrc íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
{
    "presets": ["@babel/preset-env"]
}
```

babelrc íŒŒì¼ì— presets ì‘ì„±í•˜ê¸° <br/>
ê°€ì¥ ìµœì‹ ì˜ í”„ë¦¬ì…‹ì¸ @babel/preset-env ë¥¼ ì‚¬ìš© í•©ë‹ˆë‹¤.

<br/><br/>

### env.js íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
import dotenv from "dotenv";
dotenv.config();
```

<br/><br/>

### schema íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
import path from "path";

import { makeExecutableSchema } from "graphql-tools";
import { fileLoader, mergeResolvers, mergeTypes } from "merge-graphql-schemas";

const allTypes = fileLoader(path.join(__dirname, "/api/**/*.graphql"));
const allResolvers = fileLoader(path.join(__dirname, "/api/**/*.js"));

const schema = makeExecutableSchema({
  typeDefs: mergeTypes(allTypes),
  resolvers: mergeResolvers(allResolvers)
});

export default schema;
```

<br/>

**schema ì„¤ëª…**

- **fileLoader** : ì¸ìë¡œ pathë¥¼ ë°›ì•„ íŒŒì¼ì„ loadí•´ì¤ë‹ˆë‹¤.
- **path.join** : í•´ë‹¹ ê²½ë¡œì˜ íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
- **makeExecutabelSchema** : type, resolverë¥¼ schema í˜•íƒœë¡œ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/src/schema.js

import path from "path"; // ì„¤ëª…[3-1]

// ì„¤ëª…[1]
import { makeExecutableSchema } from "graphql-tools";
import { fileLoader, mergeResolvers, mergeTypes } from "merge-graphql-schemas";

// ì„¤ëª…[3]
const allTypes = fileLoader(path.join(__dirname, "/api/**/*.graphql"));
const allResolvers = fileLoader(path.join(__dirname, "/api/**/*.js"));

// ì„¤ëª…[2]
const schema = makeExecutableSchema({
  typeDefs: mergeTypes(allTypes),
  resolvers: mergeResolvers(allResolvers)
});

// ì„¤ëª…[4]
export default schema;
```

**ì„¤ëª…[1]**

<!-- Example Code -->

```js
import { makeExecutableSchema } from "graphql-tools";
import { fileLoader, mergeResolvers, mergeTypes } from "merge-graphql-schemas";
```

graphql-tools, merge-graphql-schemas ì„¤ì¹˜í•´ ì¤€ ê²ƒë“¤ì„ ë¶ˆëŸ¬ì™€ ì¤ë‹ˆë‹¤.

<br/>

**ì„¤ëª…[2]**

<!-- Example Code -->

```js
const schema = makeExecutableSchema({
  typeDefs: mergeTypes(allTypes),
  resolvers: mergeResolvers(allResolvers)
});
```

schema íŒŒì¼ì— ìš°ì„  ëª¨ë“  type ë“¤ì„ ì¶”ê°€ í•©ë‹ˆë‹¤. <br/>
makeExecutableSchemas í•¨ìˆ˜ì˜ ì¸ìë¡œ typeDefs ì™€ resolvers ë¥¼ ì…ë ¥í•´ì£¼ë©´ ë©ë‹ˆë‹¤. <br/>
allTypes ë¼ëŠ” ë³€ìˆ˜ë¥¼ ë§Œë“¤ê³  ì´ ë³€ìˆ˜ëŠ” fileLoader í•¨ìˆ˜ì˜ ê²°ê³¼ë¬¼ ì…ë‹ˆë‹¤.

 <br/>

**ì„¤ëª…[3]**

[ì°¸ê³ ] api í´ë” ë°‘ì—ëŠ” resolver ê°€ ì•„ë‹Œ js íŒŒì¼ì„ ë‘ë©´ ì•ˆë©ë‹ˆë‹¤! <br/>
api í´ë” ë°‘ì—ëŠ” resolver ë‚˜ graphql ì•„ë‹Œ íŒŒì¼ì„ ë‘ì§€ ì•Šê¸°! <br/>

<!-- Example Code -->

```js
const allTypes = fileLoader(path.join(__dirname, "/api/**/*.graphql"));
const allResolvers = fileLoader(path.join(__dirname, "/api/**/*.js"));
```

fileLoader í•¨ìˆ˜ì˜ ì¸ìë¡œ path.join(\_\_dirname, "/api/**/\*.graphql") ì„ ì…ë ¥
** ëŠ” ëª¨ë“  í´ë”ê³ , \*.graphql ì€ ëª¨ë“  .graphql íŒŒì¼ ì…ë‹ˆë‹¤. <br/>

ë‹¤ì‹œë§í•´ api í´ë” ë°‘ì˜ ëª¨ë“  í´ë”ì— ì†í•´ìˆê³  .graphql ë¡œ ëë‚˜ëŠ” ëª¨ë“  íŒŒì¼ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒ ì…ë‹ˆë‹¤. <br/>

ê°™ì€ ë°©ì‹ìœ¼ë¡œ allResolvers ë¥¼ ë§Œë“¤ê¸° <br/>
ì´ë ‡ê²Œ í•˜ë©´ ì•„ì£¼ ê¸´ íŒŒì¼ê²½ë¡œë¥¼ ì…ë ¥í•˜ê²Œ ë˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤. <br/>
api í´ë” ë°‘ì— ëª¨ë“  í´ë”ì˜ íŒŒì¼ë“¤ ì¤‘ .js ë¡œ ëë‚˜ëŠ” íŒŒì¼ë“¤ì„ ì…ë ¥í•˜ê¸°

<br/>

```js
import path from "path"; // ì„¤ëª…[3-1]
```

fileLoader í•¨ìˆ˜ì˜ ì¸ìë¡œ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì…ë ¥ í•´ì•¼ í•©ë‹ˆë‹¤. <br/>
path ëª¨ë“ˆì„ import í•˜ê¸°

<br/>

**ì„¤ëª…[4]**

<!-- Example Code -->

```js
export default schema;
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ë‚´ë³´ë‚´ì£¼ë©´ ë©ë‹ˆë‹¤.

<br/><br/>

### package.json

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/package.json

{
  "name": "prismagram",
  "version": "1.0.0",
  "description": "Instragram clone with Express + Prisma + React and React Native",
  //"main": "index.js", ì´ë¶€ë¶„ì€ í•„ìš”ì—†ìœ¼ë¯€ë¡œ ì´ ì¤„ ì‚­ì œí•˜ê¸°
  "license": "MIT",
  "dependencies": {
    "graphql-yoga": "^1.18.2"
  }
}
```

**scripts ì¶”ê°€í•˜ê¸°**

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/package.json

"scripts": {
	  "dev": "nodemon --exec babel-node src/server.js",
	  "deploy": "prisma deploy",
	  "generate": "prisma generate",
	  "prisma": "yarn run deploy && yarn run generate",
	  "prebuild": "yarn run generate",
	  "build": "babel src -d build",
	  "postbuild": "npx copy src/api/**/**.graphql ./build/api/",
	  "start": "node build/server.js"
}
```

**ì‹¤í–‰**

<!-- Example Code -->

```js
$ yarn dev
```

<br/><br/>

# Datamodel & Migrations ë°°í¬

<!-- Example Code -->

```js
$ prisma deploy
```

package.json ì— `"prisma": "yarn run deploy && yarn run generate",` ì‘ì„±í•˜ê³  ì•„ë˜ ì²˜ëŸ¼ ë°°í¬í•´ë„ ë©ë‹ˆë‹¤.

<!-- Example Code -->

```js
$ yarn prisma
```

<br/><br/>

# ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” (bcrypt ë¼ì´ë¸ŒëŸ¬ë¦¬)

### ëª…ë ¹í”„ë¡¬í”„íŠ¸, powershell ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ í›„ ì„¤ì¹˜

<!-- Install Code -->

```js
$ yarn global add windows-build-tools
```

ìœˆë„ìš°ì—ì„œ í•„ìˆ˜ì¸ c, c++ ê´€ë ¨ëœ ê²ƒë“¤ê³¼ íŒŒì´ì¬ê°™ì€ ê²ƒì„ ì„¤ì¹˜í•´ì„œ ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥´ ì§€ì›í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

<br/>

### í„°ë¯¸ë„ì—ì„œ ì„¤ì¹˜

<!-- Install Code -->

```js
$ yarn global add node-pre-gyp
$ yarn add bcrypt@3.0.6
$ yarn add @types/bcrypt --dev
```

<br/>

### ì‚¬ìš©ë²•

**async (recommended)**

<!-- Example Code -->

```js
const bcrypt = require("bcrypt");
const saltRounds = 10;
const myPlaintextPassword = "s0//P4$$w0rD";
const someOtherPlaintextPassword = "not_bacon";
```

saltRounds = salt ë¥¼ ë§Œë“¤ ë•Œì˜ 10ìë¦¬ì¸ Salt ë¥¼ ë§Œë“¤ì–´ ë‹¬ë¼ëŠ” ê²ƒ ì…ë‹ˆë‹¤.

<br/>

**To hash a password: Technique 1**

<!-- Example Code -->

```js
bcrypt.genSalt(saltRounds, function(err, salt) {
  bcrypt.hash(myPlaintextPassword, salt, function(err, hash) {
    // Store hash in your password DB.
  });
});
```

ë³„ë„ì˜ í•¨ìˆ˜ í˜¸ì¶œì—ì„œ Salt ë° hash ìƒì„±í•˜ê¸° <br/>
Salt ë¥¼ ì´ìš©í•´ì„œ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” í•˜ê¸°

<br/>

### íšŒì›ê°€ì… ì‹œ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/src/passwordMatch.js

import bcrypt from "bcrypt";

export const hashPassword = (password, saltRounds) =>
  bcrypt.hash(password, saltRounds);
```

**bcrypt.hash ì„¤ëª…**

<!-- Example Code -->

```js
// ì°¸ê³ 
const hash = bcrypt.hashSync(myPlaintextPassword, saltRounds);
bcrypt.hash(password, 10);
```

ì²« ë²ˆì§¸ ì¸ì myPlaintextPassword ì—ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³´ë‚´ì£¼ê³  <br/>
ë‘ ë²ˆì§¸ ì¸ì saltRounds ì—ëŠ” salt ë¥¼ ë§Œë“¤ ë•Œì˜ 5ìë¦¬ì¸ Salt ë¥¼ ë§Œë“¤ì–´ ë‹¬ë¼ëŠ” ê²ƒ ì…ë‹ˆë‹¤.

<br/>

**ê³„ì • ì¶”ê°€**

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/src/api/User/createAccount/createAccount.graphql

type Mutation {
    createAccount(
        email: String!
        userName: String!
        password: String!
        avatar: String
    ): Boolean!
}
// ì•„ë˜ëŠ” ë§Œì•½ ì¿¼ë¦¬ê°€ ì—†ë‹¤ê³  ì˜¤ë¥˜ ëœ° ê²½ìš° ê°€ì§œ ì¿¼ë¦¬ ë§Œë“¤ì–´ì£¼ê¸°
type Query {
  createAccount: String!
}
```

<br/>

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/src/api/User/createAccount/createAccount.js

import { prisma } from "../../../../generated/prisma-client";
import { hashPassword } from "../../../passwordMatch";

export default {
  Mutation: {
    createAccount: async (_, args) => {
      const { email, userName, password, avatar } = args;

      const ExistUserName = await prisma.$exists.user({
        userName
      });
      const ExistEmail = await prisma.$exists.user({
        email
      });

      if (ExistUserName) {
        throw Error("ì´ë¯¸ ìˆëŠ” ì´ë¦„ ì…ë‹ˆë‹¤.");
      } else if (ExistEmail) {
        throw Error("ì´ë¯¸ ìˆëŠ” ì´ë©”ì¼ ì…ë‹ˆë‹¤.");
      }

      try {
        const hsPassword = await hashPassword(password, 5);
        await prisma.createUser({
          email,
          userName,
          password: hsPassword,
          avatar
        });
        return true;
      } catch (e) {
        console.log(e);
        return false;
      }
    }
  }
};
```

**ì„¤ëª…**

<!-- Example Code -->

```js
import { hashPassword } from "../../../passwordMatch";

const { email, userName, password, avatar } = args;
const hsPassword = await hashPassword(password, 5);
```

ì•„ë˜ ì™€ ê°™ì´ `passwordMatch.js` ì—ì„œ hashPassword í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ ë˜ë©´ <br/>
ì²« ë²ˆì§¸ ì¸ì - ë¹„ë°€ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì¸ì - Salt ê¸€ì ìˆ˜ ë¥¼ ë„£ê²Œë˜ë©´ ë³´ë‚¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì•”í˜¸í™”í•´ì„œ ëŒë ¤ì£¼ê²Œ ë©ë‹ˆë‹¤. <br/>

<br/>

**ì•”í˜¸í™” ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ hsPassword ë³€ìˆ˜ ë„£ê¸°**

<!-- Example Code -->

```js
// passwordMatch.js
import bcrypt from "bcrypt";

export const hashPassword = (password, saltRounds) =>
  bcrypt.hash(password, saltRounds);
```

<br/>

**ì•”í˜¸í™” ëœ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸**

<!-- Example Code -->

```js
await prisma.createUser({
  email,
  userName,
  password: hsPassword,
  avatar
});
```

<br/><br/>

# í† í° ì¸ì¦ê¸°ëŠ¥ ì‰½ê²Œ ì—°ê²° (passport-jwt ë¼ì´ë¸ŒëŸ¬ë¦¬)

ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ë¹„ë°€ë²ˆí˜¸ì™€ ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ê°’ì´ ê°™ë‹¤ë©´ í† í°ì„ ë¦¬í„´í•´ì£¼ê¸°

<br/>

### passportjs

ì¸ì¦ í† í°ì„ ìœ„í•´ passportjs ë¥¼ ì‚¬ìš©í•˜ê¸° <br/>
passportjs ëŠ” ëª¨ë“  ì¸ì¦ ê¸°ëŠ¥ì„ ì•„ì£¼ ì‰½ê²Œ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤. <br/>
passport ë¥¼ ì„¤ì¹˜í•˜ê³  ì„¤ì •ë§Œ í•´ì£¼ë©´ ëª¨ë“  ì¸ì¦ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

### passport-jwt ì„¤ì¹˜

<!-- Install Code -->

```js
yarn add passport-jwt passport
```

<br/>

### passport ì—°ê²°í•˜ê¸°

passport ëŠ” ì¸ì¦ ê´€ë ¨ ëª¨ë“  ì¼ì„ í•©ë‹ˆë‹¤. <br/>
í† í°ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ (express ì˜) request ì— ë¶™ì—¬ ì¤ë‹ˆë‹¤. <br/>
í† í°ì„ ê°€ì ¸ì™€ì„œ í•´ë…í•œ í›„ì— ì‚¬ìš©ì ê°ì²´ë¥¼ requestì— ì¶”ê°€ í•´ì¤ë‹ˆë‹¤. <br/>

ë‹¤ì‹œë§í•´ jwt í† í°ì´ë‚˜ ì¿ í‚¤ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ì‚¬ìš©ì ì •ë³´ì— ì €ì¥ í•©ë‹ˆë‹¤. <br/>
ì´ ëª¨ë“  ê²ƒì„ ìë™ìœ¼ë¡œ í•´ì£¼ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.

<br/>

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/passport.js

import passport from "passport";
import { Strategy, ExtractJwt } from "passport-jwt";
import { prisma } from "../generated/prisma-client";

const jwtOptions = {
  jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
  secretOrKey: process.env.JWT_SECRET
};

const verifyUser = async (payload, done) => {
  try {
    const user = await prisma.user({ id: payload.id });
    if (user !== null) {
      return done(null, user);
    } else {
      return done(null, false);
    }
  } catch (error) {
    return done(error, false);
  }
};

export const authenticateJwt = (req, res, next) =>
  passport.authenticate("jwt", { sessions: false }, (error, user) => {
    if (user) {
      req.user = user;
    }
    next();
  })(req, res, next);

passport.use(new Strategy(jwtOptions, verifyUser));
passport.initialize();
```

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/.env

JWT_SECRET = "ëœë¤ ë¬¸ìì—´ ë„£ì–´ì£¼ë©´ ëœë‹¤.";
```

<br/>

### í† í° í•´ì„, authenticateJwt í•¨ìˆ˜ ì‹¤í–‰

í† í°ì„ í•´ì„í•˜ë ¤ë©´ passport ê°€ í•„ìš” í•©ë‹ˆë‹¤.

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/server.js

import "./env";
import { GraphQLServer } from "graphql-yoga";
import logger from "morgan";
import schema from "./schema";
import "./passport";
import { authenticateJwt } from "./passport";

const PORT = process.env.PORT || 4000;

console.log(process.env.PORT);

// [2]
const server = new GraphQLServer({
  schema,
  context: ({ request }) => ({ request })
});

server.express.use(logger("dev"));
server.express.use(authenticateJwt);

server.start({ port: PORT }, () =>
  console.log(`âœ” Server running on http://localhost:${PORT}`)
);
```

**passport ì„¤ëª…**

<!-- Example Code -->

```js
import "./passport";
```

passport.js íŒŒì¼ì— passport ëª¨ë“ˆì´ import ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <br/>
server.js ì—ì„œëŠ” passport.js íŒŒì¼ì—ì„œ ë¬´ì–¸ê°€ë¥¼ ë°›ì•„ì„œ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

<br/>

**authenticateJwt ì„¤ëª…**

<!-- Example Code -->

```js
import { authenticateJwt } from "./passport";

server.express.use(authenticateJwt);
```

authenticateJwt ë¥¼ ì‹¤í–‰í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.

<br/>

ëª¨ë“  resolver ì— ì •ë³´ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•´ context ë¥¼ ì‚¬ìš© í•  ìˆ˜ìˆë‹¤.

<!-- Example Code -->

```js
const server = new GraphQLServer({
  schema,
  context: ({ request }) => ({ request })
});
```

resolver ì´ ì•Œ ìˆ˜ ìˆë„ë¡ ì „ë‹¬í•´ ì¤ë‹ˆë‹¤ë‹¤. <br/>
context ëŠ” resolver ì‚¬ì´ì—ì„œ ì •ë³´ë¥¼ ê³µìœ í•  ë•Œ ì‚¬ìš©í•œë‹¤.

<br/><br/>

# jwtë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²• (jsonwebtoken ë¼ì´ë¸ŒëŸ¬ë¦¬)

`passport.js` ì—ì„œ ì‘ì—… í•œ jwt ë¥¼ ê°€ì ¸ì™€ì„œ í•´ì„í•˜ê³  í™•ì¸í•˜ëŠ” ì‘ì—… ì…ë‹ˆë‹¤.

### jsonwebtoken ì„¤ì¹˜

<!-- Install Code -->

```js
$ yarn add jsonwebtoken
```

`jwt.sign(payload, secretOrPrivateKey, [options, callback])` <br/>
sign í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•  ë•Œ payload ë¥¼ ì…ë ¥ í•´ì•¼ í•©ë‹ˆë‹¤. <br/>
ìš°ë¦¬ëŠ” payload ìœ„ì¹˜ì— ì‚¬ìš©ìì˜ id ë¥¼ ì…ë ¥ í•©ë‹ˆë‹¤. <br/>
ê·¸ë¦¬ê³  secret key ë¥¼ ì…ë ¥ í•´ì•¼ í•©ë‹ˆë‹¤.

<br/>

**ì‚¬ìš©ë²• ì ìš©**

<!-- Example Code -->

```js
// jwt.sign(payload, secretOrPrivateKey, [options, callback])
jwt.sign({ id }, process.env.JWT_SECRET);
```

<br/>

### generateToken íŒŒì¼ ìƒì„±

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/generateToken.js

import jwt from "jsonwebtoken";

export const generateToken = (id) => jwt.sign({ id }, process.env.JWT_SECRET);
```

<br/><br/>

# ë¹„ë°€ë²ˆí˜¸ í™•ì¸í•˜ê¸° (jsonwebtoken ì‚¬ìš©)

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/passwordMatch.js

import bcrypt from "bcrypt";

export const hashPassword = (password, saltRounds) =>
  bcrypt.hash(password, saltRounds);
export const passwordMatch = (password, userPassword) =>
  bcrypt.compare(password, userPassword);
```

<br/>

### ë¡œê·¸ì¸í•œ ìœ ì € í† í° ìƒì„±

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/api/User/confirmPassword/confirmPassword.graphql

type Mutation {
    confirmPassword(email: String!, password: String!): String!
}
```

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/api/User/confirmPassword/confirmPassword.js

import { prisma } from "../../../../generated/prisma-client";
import { generateToken } from "../../../generateToken";
import { passwordMatch } from "../../../passwordMatch";

export default {
  Mutation: {
    confirmPassword: async (_, args) => {
      const { email, password } = args;
      const user = await prisma.user({ email });
      if (!user) {
        throw Error("ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
      const passwordConfirm = await passwordMatch(password, user.password);
      if (!passwordConfirm) {
        throw Error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.");
      }

      return generateToken(user.id);
    }
  }
};
```

### ì„¤ëª…

**email ê³¼ password ë°›ê¸°**

<!-- Example Code -->

```js
const { email, password } = args;
const user = await prisma.user({ email });
```

ë°›ì€ email ë¡œ user ë¥¼ prisma ì—ì„œ ì°¾ì€ í›„ user ë³€ìˆ˜ì— ë„£ê¸°

<br/>

**ë¹„ë°€ë²ˆí˜¸ í™•ì¸**

<!-- Example Code -->

```js
import { passwordMatch } from "../../../passwordMatch";

const passwordConfirm = await passwordMatch(password, user.password);
```

ì•„ë˜ ì™€ ê°™ì´ `passwordMatch.js` ì—ì„œ passwordMatch í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ ë˜ë©´ ì²« ë²ˆì§¸ ì¸ì - ìœ ì €ê°€ ì ì€ ë¹„ë°€ë²ˆí˜¸, ë‘ ë²ˆì§¸ ì¸ì - prismaì— ìˆëŠ” ìœ ì € ë¹„ë°€ë²ˆí˜¸ ë¥¼ ë„˜ê²¨ì£¼ê²Œ ë©ë‹ˆë‹¤. <br/>
passwordMatch í•¨ìˆ˜ì— Boolean ê°’ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸ í•´ì¤ë‹ˆë‹¤. <br/>
Boolean ê°’ì€ passwordConfirm ë³€ìˆ˜ì— ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤.

<!-- Example Code -->

```js
// passwordMatch.js
import bcrypt from "bcrypt";

export const passwordMatch = (password, userPassword) =>
  bcrypt.compare(password, userPassword);
```

<br/>

**í† í° ìƒì„±**

<!-- Example Code -->

```js
import { generateToken } from "../../../generateToken";

return generateToken(user.id);
```

ì•„ë˜ ì™€ ê°™ì´ generateToken.js ì—ì„œ generateToken í•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¤ê²Œ ë˜ë©´ í† í°ì„ ìƒì„± í•  ìˆ˜ ìˆë‹¤.

<!-- Example Code -->

```js
// generateToken.js
import jwt from "jsonwebtoken";

export const generateToken = (id) => jwt.sign({ id }, process.env.JWT_SECRET);
```

<br/><br/>

# middleware

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/middlewares.js

export const isAuthenticated = (request) => {
  if (!request.user) {
    throw Error("You need to log in to perform this action");
  }
  return;
};
```

express middeleware ëŠ” ì•„ë‹ˆê³  graphQl middleware ë‘ ê°™ì€ ê²ƒ ì…ë‹ˆë‹¤. <br/>
ì´ê±´ API ë°–ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

<br/>

<!-- Example Code -->

```js
// ~/wam-prj/prismagram/src/server.js

import "./env";
import { GraphQLServer } from "graphql-yoga";
import logger from "morgan";
import schema from "./schema";
import "./passport";
import { authenticateJwt } from "./passport";
import { isAuthenticated } from "./middlewares";

const PORT = process.env.PORT || 4000;

const server = new GraphQLServer({
  schema,
  context: ({ request }) => ({ request, isAuthenticated })
});

server.express.use(logger("dev"));
server.express.use(authenticateJwt);
server.start({ port: PORT }, () =>
  console.log(`âœ” Server running on http://localhost:${PORT}`)
);
```

ë§Œì•½ server.jsì— isAuthenticated ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ê° íŒŒì¼ë§ˆë‹¤ import í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

<br/><br/>

# ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³´ë‚´ê¸° (Nodemailer ì‚¬ìš©)

### ì´ë©”ì¼ì„ ë³´ë‚´ê¸° ìœ„í•´ nodemailer ì„¤ì¹˜

<!-- Install Code -->

```js
$ yarn add nodemailer
$ yarn add nodemailer-sendgrid-transport
```

<br/>

### sendgrid ì‚¬ìš©ë²•

<!-- Example Code -->

```js
// sending-email-nodemailer-sendgrid

var nodemailer = require('nodemailer');
var sgTransport = require('nodemailer-sendgrid-transport'); // ì„¤ì¹˜í•˜ê¸°

// options
var options = {
  auth: {
    api_user: 'SENDGRID_USERNAME',
    api_key: 'SENDGRID_PASSWORD'
  }
}

var client = nodemailer.createTransport(sgTransport(options));

var email = {
  from: 'awesome@bar.com',
  to: 'mr.walrus@foo.com',
  subject: 'Hello',
  text: 'Hello world',
  html: '<b>Hello world</b>'
};

client.sendMail(email, function(err, info){
    if (err ){
      console.log(error);
    }
    else {
      console.log('Message sent: ' + info.response);
    }
});
To continue using Nodemailer with SMTP, just set your service to â€˜SendGridâ€™ as shown below.

var client = nodemailer.createTransport({
  service: 'SendGrid',
  auth: {
    user: 'SENDGRID_USERNAME',
    pass: 'SENDGRID_PASSWORD'
  }
});

// See above
```

<br/>

### Nodemailer ì‚¬ìš©

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/.env

SENDGRID_USERNAME = "sendgrid ì‚¬ì´íŠ¸ì˜ UserName ë„£ìœ¼ë©´ ëœë‹¤.";
SENDGRID_PASSWORD = "sendgrid ì‚¬ì´íŠ¸ì˜ Password ë„£ìœ¼ë©´ ëœë‹¤.";
```

<br/>

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/utils.js

import { adjectives, nouns } from "./words";
import nodemailer from "nodemailer";
import sgTransport from "nodemailer-sendgrid-transport";

export const generatorSecret = () => {
  const randomNumber = Math.floor(Math.random() * adjectives.length);
  return `${adjectives[randomNumber]}${nouns[randomNumber]}`;
};

const sendMail = (email) => {
  const options = {
    auth: {
      api_user: process.env.SENDGRID_USERNAME,
      api_key: process.env.SENDGRID_PASSWORD
    }
  };
  const client = nodemailer.createTransport(sgTransport(options));
  return client.sendMail(email);
};

export const sendSecretMail = (address, secret) => {
  const email = {
    from: "admin@melona.com",
    to: address,
    subject: "ğŸ”’ Login Secret for Melona ğŸ”’",
    html: `Hello! Your login secret is <strong>${secret}</strong>.<br/>Copy paste on the app/website to log in`
  };
  return sendMail(email);
};
```

### sendMail ì„¤ëª…

**ê³„ì • ì •ë³´ ì ‘ê·¼ í›„ ì˜µì…˜ ë§Œë“¤ê¸°**

<!-- Example Code -->

```js
console.log(process.env.SENDGRID_USERNAME, process.env.SENDGRID_PASSWORD);

const sendMail = (email) => {
  const options = {
    auth: {
      api_user: process.env.SENDGRID_USERNAME,
      api_key: process.env.SENDGRID_PASSWORD
    }
  };
};
```

<br/>

**client.sendMail ì‹¤í–‰**

<!-- Example Code -->

```js
import nodemailer from "nodemailer";
import sgTransport from "nodemailer-sendgrid-transport";

const sendMail = (email) => {
  const options = {
    auth: {
      api_user: process.env.SENDGRID_USERNAME,
      api_key: process.env.SENDGRID_PASSWORD
    }
  };
  const client = nodemailer.createTransport(sgTransport(options));
  return client.sendMail(email);
};
```

nodemailer.createTransport(sgTransport(options)) ë¥¼ ì‹¤í–‰í•œ ê²°ê³¼ë¬¼ì„ client ì— í• ë‹¹í•˜ê¸°

`sgTransport` ëª‡ëª‡ ê¸°ë³¸ ê°’ë“¤ë¡œ transport ë¼ëŠ” ê±¸ ë§Œë“¤ê³  ê·¸ê±¸ sendMail ì„ ìš”ì²­í•˜ë©´ ë ì…ë‹ˆë‹¤. <br/>

transport ê°€ ëŒ€ì‹  ì•Œì•„ì„œ í•´ì¤ë‹ˆë‹¤.

<br/>

**sendSecretMail í•¨ìˆ˜ì—ì„œ sendMail í•¨ìˆ˜ ì‹¤í–‰**

<!-- Example Code -->

```js
export const sendSecretMail = (address, secret) => {
  const email = {
    from: "melona@melona.com",
    to: address,
    subject: "ğŸ”’ Login Secret for Melona ğŸ”’",
    html: `Hello! Your login secret is <strong>${secret}</strong>.<br/>Copy paste on the app/website to log in`
  };
  return sendMail(email);
};
```

sendSecretMail ë¥¼ ì‚¬ìš©í•˜ê³  sendMail ì€ ì™¸ë¶€ ì—ì„œ ì‚¬ìš© í•˜ì§€ ì•Šìœ¼ë‹ˆ export í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

<br/><br/>

# AWS S3ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ì§„ ì €ì¥

### Access key ë°±ì—”ë“œ env íŒŒì¼ì— ë„£ì–´ì£¼ê¸°

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/.env

AWS_KEY = "Access key ë„£ì–´ì£¼ë©´ ëœë‹¤.";
AWS_SECRET = "Secret access key ë„£ì–´ì£¼ë©´ ëœë‹¤.";
```

ë²„í‚· ìƒì„± í›„ AWS_KEYì™€ AWS_SECRET ë„£ì–´ì£¼ê¸°

<br/>

### multer-s3 ì„¤ì¹˜

<!-- Install Code -->

```js
$ yarn add multer-s3
$ yarn add aws-sdk
```

<br/>

### multer-s3 ì ìš©

<!-- Example Code -->

```js
// ~/wam-prj/melona-backend/src/upload.js

import multer from "multer";
import multerS3 from "multer-s3";
import aws from "aws-sdk";

const s3 = new aws.S3({
  accessKeyId: process.env.AWS_KEY, // ìƒì„±í•œ s3ì˜ accesskey
  secretAccessKey: process.env.AWS_SECRET, // ìƒì„±í•œ s3ì˜ secret key
  region: "ap-northeast-2" // ì§€ì—­ì„¤ì •
});

const upload = multer({
  storage: multerS3({
    s3,
    acl: "public-read", // ì—…ë¡œë“œ ëœ ë°ì´í„°ë¥¼ URLë¡œ ì½ì„ ë•Œ ì„¤ì •í•˜ëŠ” ê°’ì…ë‹ˆë‹¤. ì—…ë¡œë“œë§Œ í•œë‹¤ë©´ í•„ìš”ì—†ìŠµë‹ˆë‹¤.
    bucket: "melona.cf", // s3 ìƒì„±ì‹œ ë²„í‚·ëª…
    metadata: function(req, file, cb) {
      cb(null, { fieldName: file.fieldname }); // íŒŒì¼ ë©”íƒ€ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
    },
    key: function(req, file, cb) {
      cb(null, Date.now().toString());
    }
  })
});
export const uploadMiddleware = upload.single("file");

export const uploadController = (req, res) => {
  const {
    file: { location }
  } = req;
  res.json({ location });
};
```

<br/><br/>
